#!/bin/bash

set -eox pipefail

# Use Docker BuildKit to efficiently build the targets.
# With BuildKit, only relevant layers for the target are built.
export DOCKER_BUILDKIT=1

# go to repo root folder for execution
cd $(dirname $0)/..

. bin/utils

VERSION=unreleased
# Version derived from CHANGELOG and automated release library
[ -f VERSION ] && VERSION=$(<VERSION)
FULL_VERSION_TAG="$VERSION-$(git_tag)"

echo "---"

function main() {
  retrieve_cyberark_ca_cert
  build_docker_image
}

function build_docker_image() {

  echo "Building conjur-k8s-csi-provider:$FULL_VERSION_TAG Docker image"

  docker build \
    --target "conjur-k8s-csi-provider" \
    --tag "conjur-k8s-csi-provider:dev" \
    --tag "conjur-k8s-csi-provider:${FULL_VERSION_TAG}" \
    --tag "conjur-k8s-csi-provider:latest" \
    .

  echo "---"

  echo "Building conjur-k8s-csi-provider-redhat:$FULL_VERSION_TAG Docker image"

  docker build \
    --target conjur-k8s-csi-provider-redhat \
    --build-arg VERSION="$FULL_VERSION_TAG" \
    --tag "conjur-k8s-csi-provider-redhat:${FULL_VERSION_TAG}" \
    --tag "conjur-k8s-csi-provider-redhat:latest" \
    .
}

main
